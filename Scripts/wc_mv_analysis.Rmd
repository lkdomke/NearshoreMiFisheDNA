---
title: "wc_mv_analysis"
output: html_document
date: "2025-01-24"
editor_options: 
  chunk_output_type: console
---

**Abundance only mulitvariate approach**

This is a script adapted from the 'mv_edna_seine_exploration.rmd' that takes the same approach:

- clean data and combine eDNA and seine into a single dataframe

- perform wisconsin standardization

- calculate dissimilarity metrics (previously we did both binary and abundance-based metrics, but we think there's some flaws with transforming the abundance data to binary - mainly it creates more within group dispersion than is allowable to perform PERMANOVAs likely because we think its inflating the influence of rare species)

- test permanova for difference in groups (habitat x gear)

  - follow up with any pairwise testing as appropriate
  
- visualize the difference (likely best done with pcoa; since we've had high stress levels)

- simper & indicator species analysis (ISA) to look at either what is (simper) "driving the differences we see between the groups" or (ISA) that for each species is conducted independently (need to correct for multiple testing) but "identifying species that can be used as indicators of certain site groups" which is an associated between a species and site group. Often this ends up being that a species shows up in most of 100% of the sites (or combination of sites) that belong to a group. 

**Addition data review steps:**

- create nice indicator plots w/ abundance data included

- create plot of seine data in proportional form against species abundance and facet wrap by habitat (or something along those lines)

# library
```{r}
library(tidyverse)
library(lubridate)
library(ggrepel)
library(patchwork)
library(ggforce)
library(vegan)
extrafont::loadfonts(device="win")
```

# custom fxn
```{r theme settings, include=FALSE}
# Creates custom base plot theme that can adjust every graph that you use plot_theme for!

plot_theme <- function() {
  theme_bw(base_size = 20, base_family = "Calibri") %+replace%
    theme(panel.background  = element_blank(),
            plot.background = element_rect(fill="white", colour=NA), 
            legend.background = element_rect(fill="transparent", colour=NA),
            legend.key = element_rect(fill="transparent", colour=NA),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            strip.background = element_rect(colour = "NA", fill = "grey96"))
}

# to use ggsave and export plots include argument 'device=cario_pdf' e.g.: 
# ggsave("name.pdf", device=cairo_pdf, width = 6, height = 6)

plot_theme_small <- function() {
  theme_bw(base_size = 18, base_family = "Calibri") %+replace%
    theme(panel.background  = element_blank(),
            plot.background = element_rect(fill="white", colour=NA), 
            legend.background = element_rect(fill="transparent", colour=NA),
            legend.key = element_rect(fill="transparent", colour=NA),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(),
            strip.background = element_rect(colour = "NA", fill = "grey96"))
}


plot_theme_bw <- function() {
  theme_bw(base_size = 20, base_family = "Calibri") %+replace%
    theme(panel.background  = element_blank(),
            plot.background = element_rect(fill="white", colour=NA), 
            legend.background = element_rect(fill="transparent", colour=NA),
            legend.key = element_rect(fill="transparent", colour=NA),
            # panel.grid.major = element_blank(), 
            # panel.grid.minor = element_blank(),
            strip.background = element_rect(colour = "NA", fill = "grey96"))
}
```

global label fxn 
```{r}
add_global_label <- function(pwobj, Xlab = NULL, Ylab = NULL, Xgap = 0.03, Ygap = 0.03, ...) {
    ylabgrob <- patchwork::plot_spacer()
    if (!is.null(Ylab)) {
        ylabgrob <- ggplot() +
            geom_text(aes(x = .5, y = .5), label = Ylab, angle = 90, ...) +
            theme_void()
    }
    if (!is.null(Xlab)) {
        xlabgrob <- ggplot() +
            geom_text(aes(x = .5, y = .5), label = Xlab, ...) +
            theme_void()
    }
    if (!is.null(Ylab) & is.null(Xlab)) {
        return((ylabgrob + patchworkGrob(pwobj)) + 
            patchwork::plot_layout(widths = 100 * c(Ygap, 1 - Ygap),
                                   tag_level = "keep"))
    }
    if (is.null(Ylab) & !is.null(Xlab)) {
        return((ylabgrob + pwobj) + 
            (xlabgrob) +
            patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                   widths = c(0, 100),
                                   tag_level = "keep",
                                   design = "
                                   AB
                                   CC
                                   "
            ))
    }
    if (!is.null(Ylab) & !is.null(Xlab)) {
        return((ylabgrob + pwobj) + 
            (xlabgrob) +
            patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                   widths = 100 * c(Ygap, 1 - Ygap),
                                   tag_level = "keep",
                                   design = "
                                   AB
                                   CC
                                   "
            ))
    }
    return(pwobj)
}
```

# mock community data & cleanup
```{r}
# pull data from Kim's repository that we cloned and placed on our desktop - so if Kim makes any updates to the quant model that was used to generate these data them we need to pull it again
edna <- read.csv("../nearshore_eDNA/outputs/samples_w_mocks_updated/field_quant/qm_results_20241125.csv") %>%
  dplyr::select(-c(X, comm_idx:mock1.97.5, raw.2.5:raw.97.5, SP)) %>%
  mutate(Species = ifelse(Species == "zRefSpecies_Clupea pallasii", "Clupea pallasii", Species),
         type = "edna") %>%
  unite("bay_year", c(bay_id, collection_year))
# for now we're going to focus on the simple.Mean column which is the  mean at the field replicate (bottle) level that averages the technical (PCR) replicates. 


# for the beach seine data, we want to pull both the beach seine abundance and biomass data for 2021 and 2022. 
seine <- read.csv("Data/seine_biomass_at_edna_sites.csv") %>%
  dplyr::select(c(bay_year, bay_id, habitat, sp_code, species_common, species_scientific, 
                  fork_length, mass_g, abundance)) %>%
  mutate(type = "seine")


```

Subset data cleanup
```{r}
# subset mock community eDNA to just the sites that had both eDNA and seine data - this is removing the sites that had just eDNA
edna.red <- filter(edna, !(bay_year %in% c("KLWA_A_2021", "BTRB_A_2021", "CLAM_A_2021", "NFEI_B_2021")))

edna.wide <- edna.red %>%
  dplyr::select(alternative_ID, habitat, type, Species, raw.mean, bay_year) %>%
  distinct() %>%
  dplyr::rename(bay_year2 = bay_year, 
                bay_year = alternative_ID) %>%
  pivot_wider(., names_from = "Species", 
              values_from = raw.mean, 
              values_fn = function(x) sum(x, na.rm = T), 
              values_fill = 0) %>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))

seine.info <- read.csv("Data/seine_biomass_at_edna_sites.csv") %>%
  dplyr::select(c(bay_year, place_name, habitat, date, julian, latitude, longitude)) %>%
  distinct() %>%
  mutate(type = "seine",
         bay_year2 = bay_year) %>% #
  mutate(habitat = ifelse(bay_year == "BLAQ_A_2022", "mixed", habitat),
         habitat = ifelse(bay_year == "TAHB_A_2021", "mixed", habitat),
         habitat = ifelse(bay_year == "SFEI_A_2022", "eelgrass", habitat))

edna.info <- edna.wide %>%
  dplyr::select(c(bay_year, bay_year2, habitat, type)) %>%
  left_join(seine.info[c("bay_year", "place_name", "date", "julian", "latitude", "longitude")],
            by = c("bay_year2" = "bay_year"))

site.info <- edna.info %>%
  #dplyr::select(-bay_year2) %>%
  rbind(seine.info) %>%
  mutate(date = mdy(date),
         year = year(date)) %>%
  unite(., col = "intx", c(habitat:type), 
        sep = "_", remove = F) %>%
  mutate(intx = as.factor(intx))
```

# WHOLE COMMUNITY
## Remove extra df
```{r}
rm(list = ls()[!ls() %in% c("edna.red", "seine", "site.info", "plot_theme",
                            "add_global_label", "plot_theme_small")])
```

# whole community data
```{r}
# pull the eDNA code with associated alternative ID and bay_year identification
edna.join <- edna.red %>% # this has the sites removed that don't have associated seine samples
  dplyr::select(community, alternative_ID, bay_year, habitat) %>%
  distinct() # 102 total samples- matches our site.info for edna

edna.com <- read.csv("Data/all_taxa_simple_20250110.csv") %>%
  filter(bottle %in% unique(edna.join$community)) %>%
  dplyr::select(c(bottle, taxon, simple.mean, simple.SD)) %>%
  left_join(edna.join, by = c("bottle" = "community")) %>%
  dplyr::select(c(taxon, simple.mean, simple.SD, alternative_ID, bay_year, habitat))

taxongrp <- read.csv("Data/taxonomy_groups_20250110.csv") %>% # needs a couple changes to make the left_join adjustments work. Oncorhynchus and Leptocottus armatus species has more than one join so need to get rid of the species level 
  filter(!(taxon %in% c("Oncorhynchus kisutch","Oncorhynchus gorbuscha", 
                        "Oncorhynchus keta", "Oncorhynchus mykiss", 
                        "Oncorhynchus nerka", "Leptocottus armatus",
                        "Sebastes nigrocinctus"))) %>% # small clean up on family level
  mutate(taxonomic_level = ifelse(taxon == "Sebastes 3", "genus", taxonomic_level)) %>%
  dplyr::select(-X) %>%
  distinct()
```

Use the taxongrp csv to replace species 

```{r}
head(edna.com)
head(seine)


edna.corrected <- left_join(edna.com, taxongrp, by = c("taxon" = "species")) %>%
  # dplyr::select(-c(simple.N, simple.mean, simple.SD, alternative_ID, bay_year)) %>%
  # distinct() %>%
  mutate(corrected_sp = ifelse(is.na(taxon.y), taxon, taxon.y)) %>%
  group_by(alternative_ID, bay_year, corrected_sp) %>%
  dplyr::summarise(value = sum(simple.mean)) %>%
  mutate(type = "edna",
         bay_year2 = bay_year,
         bay_year = alternative_ID,
         habitat = NA) %>%
  ungroup() %>%
  dplyr::select(-c(alternative_ID))

# before we join with the taxon there's a few species (UNFLAT, UNSCUL, AND UNROCK) that should be assigned to the most numerous species at the site they were captured
 
# sculp.sp <- {filter(taxongrp, family == "Cottidae") %>% dplyr::select(species)} %>%
#   rbind("Artedius spp.")
# 
# pleur.sp <- {filter(taxongrp, family == "Pleuronectidae") %>% dplyr::select(species)}
#   rbind("Artedius spp.")
#   
# rock.sp <- {filter(taxongrp, family == "Sebastidae") %>% dplyr::select(species)} %>%
#   rbind("Sebastes sp")
# 
# filter(seine, bay_id == "HARM_A") %>%
#   subset(species_scientific %in% rock.sp$species) %>%
#   group_by(species_scientific) %>%
#   dplyr::summarise(sum = sum(abundance)) 

############################################
## max for sculpins at sylb_a is artedius spp.
## max sculp kahs_a is artedius spp.

## max for flatfish at REEF_A is Parophrys vetulus 
## max for flatfish at REEF_B is Parophrys vetulus

## max for rockfish at HARM_A is copper/quillback so sebastes caurinus will work cause it'll get grouped to the same sebastes match
##############################################

seine.corrected <- seine %>% # first fix the unflat, unscul, unrock species with max sp at the site
  mutate(species_scientific = ifelse(sp_code == "UNFLAT", "Parophrys vetulus", species_scientific),
         species_scientific = ifelse(sp_code == "UNSCUL", "Artedius spp.", species_scientific),
         species_scientific = ifelse(sp_code == "UNROCK", "Sebastes caurinus", species_scientific)) %>%
  mutate(species_scientific = ifelse(species_common == "Copperquillback juvenile rockfish", 
                                     "Sebastes maliger", species_scientific),
         species_scientific = ifelse(species_common == "Yellowtail/black juvenile rockfish complex",
                                     "Sebastes flavidus", species_scientific),# this isn't 100p but we'll work when we leftjoin with taxongrp to correctly put it into the right sebastes group
         species_scientific = ifelse(species_scientific == "Lepidopsetta spp.", "Lepidopsetta polyxystra",
                                     species_scientific)) %>%
  left_join(taxongrp, by = c("species_scientific" = "species")) %>%
  # dplyr::select(-c(bay_year, bay_id, habitat, fork_length, mass_g, abundance, type)) %>%
  # distinct() %>%
  mutate(corrected_sp = ifelse(is.na(taxon), species_scientific, taxon)) %>%
  group_by(bay_year, habitat, corrected_sp, type) %>%
  dplyr::summarise(value = sum(abundance)) %>%
  mutate(bay_year2 = bay_year) %>%
  group_by(bay_year, bay_year2, habitat, type) %>% # ugly code but have to change seine data to prop abund
  mutate(total = sum(value)) %>%
  ungroup() %>%
  group_by(bay_year, bay_year2, habitat, type, total, corrected_sp) %>%
  dplyr::summarize(value = sum(value)/total) %>%
  ungroup() %>%
  dplyr::select(-total) %>%
  distinct()

```


next steps: 
- group artedius spp for both beach seine and eDNA to Artedius genus level
- group irish lord to the genus levele for both beach seine and eDNA

Combine edna and seine and then group by artedius and irish lords
```{r}
head(edna.corrected)
head(seine.corrected)

comb <- rbind(edna.corrected, seine.corrected) %>%
  mutate(corrected_sp = ifelse(corrected_sp %in% c("Artedius fenestralis", "Artedius harringtoni",
                                                   "Artedius lateralis", "Artedius spp."), "Artedius spp.",
                               corrected_sp),
         corrected_sp = ifelse(corrected_sp %in% c("Hemilepidotus hemilepidotus", "Hemilepidotus spinosus",
                                                   "Hemilepidotus sp."), "Hemilepidotus spp.",
                               corrected_sp)) %>%
  group_by(bay_year, bay_year2, corrected_sp, type, habitat) %>%
  dplyr::summarize(value = sum(value)) %>%
  left_join(site.info, by = c("bay_year", "bay_year2", "type")) %>%
  mutate(habitat = habitat.y) %>%
  pivot_wider(id_cols = c(bay_year, bay_year2, type, intx, habitat, place_name, date, julian,
                          latitude, longitude, year), names_from = corrected_sp, values_from = value,
              values_fill = 0, values_fn = sum)
```


# data cleaning
## wide & long combined data
```{r}
site.info2 <- comb %>%
  dplyr::select(c(bay_year, bay_year2, intx, habitat, type, place_name,
                  date, julian, latitude, longitude, year))
  

wide <- comb %>%
  column_to_rownames(var = "bay_year") %>%
  dplyr::select(-c(bay_year2:year))

long <- wide %>%
  rownames_to_column(var = "bay_year") %>%
  pivot_longer(cols = c("Agonopsis vulsa":"Enophrys lucasi")) %>%
  left_join(site.info2, by = "bay_year")
  

anti_join(site.info2, comb, by = "bay_year")
anti_join(comb, site.info2, by = "bay_year")

```

pull out species names
```{r}
sp <- long %>%
  distinct(name)

write.csv(sp, "Data/species_name_comb.csv")
```


## standardization
```{r}
std.wide <- wisconsin(wide)
```

# disimilarity metrics
## bray 
```{r}
bray.wide <- vegdist(std.wide, method = "bray")
```

## jaccard 
this is for exploration only - past dispersion testing no downstream testing
```{r}
# change the value column to binary and then calc jaccard dissimilarity
binary.wide <- long %>%
  mutate(binary = ifelse(value <= 0, 0, 1)) %>%
  pivot_wider(id_cols = -c(bay_year2:year, value), names_from = name,
              values_from = binary) %>%
  column_to_rownames(var = "bay_year")


# I dont believe we need to standardize binary data before calculating jaccard dissimilarity
jacc.wide <- vegdist(binary.wide, method = "jaccard", binary = T)
plot(jacc.wide)
range(binary.wide)
```

## homogeneity of dispersion
randomization test to compare within-group 'dispersions' with any distance measure. This tells you if the differences between sites are because of dispersion or variation or if it truly driven by a difference in sites (as can be determined by a PERMANOVA test)

Both betadisper tests are significant indicating significant within group dispersion. 
This somewhat makes sense because each group contains the same sites just sampled with different methods
```{r}
disp.type <- betadisper(bray.wide, site.info2$type)
anova(disp.type) 
# H0 accepted (marginally); within group dispersion neglible 
# pvalue = 0.16

disp.hab <- betadisper(bray.wide, site.info2$habitat)
anova(disp.hab) 
#H0 accepted
# pvalue = 0.16

disp.year <- betadisper(bray.wide, site.info2$year)
anova(disp.year) 
#H0 accepted, p-value = 0.168

##### JACCARD DISTANCE ######
disp.type.bin <- betadisper(jacc.wide, site.info2$type)
anova(disp.type.bin)
#H0 rejected, MAJOR dispersion within group

disp.habitat.bin <- betadisper(jacc.wide, site.info2$habitat)
anova(disp.habitat.bin)
#H0 rejected, moderate evidence for within group dispersion

disp.year.bin <- betadisper(jacc.wide, site.info2$year)
anova(disp.year.bin)
#H0 accepted; no within group dispersion 
```

# permanova
```{r}
set.seed(09281992)
# write out relevant data - going to Jeanette to compare with PRIMER
# write.csv(std.wide, "Data/whole_comm_std_abund.csv")
# write.csv(binary.wide, "Data/whole_comm_binary.csv")
# write.csv(site.info2, "Data/whole_comm_site_info.csv")

###################################
##### ABUNDANCE BASED PERMANOVA ###
###################################
set.seed(09281992)

adonis2(bray.wide ~ habitat * type, data = site.info2, 
        by = "margin", perm = 999)
# significant interaction term (pvalue = 0.002)
adonis2(bray.wide ~ habitat * type + bay_year2,
        by = "margin", data = site.info)
# significant impact of site (p = 0.001) and habitat by type (p = 0.001)

# blocks
perm <- how(nperm = 999)
setBlocks <- with(site.info2, bay_year2)
adonis2(bray.wide ~ habitat * type, by = "margin", 
        permutation = perm, data = site.info2)
# there is a significant interaction of habitat by type (pvalue = 0.005)
```

## pairwise difference
We may want to test if all groups are different from each other
 (pairwise tests of differences among groups)
 ‘adonis’ does not automatically test for pairwise differences, and does
 not have an ‘ad hoc’ test to do so, hence we would have to test for
 pairwise differences individually by selecting each pair:
```{r}
# for habitat by type


# There are Multiple possible pairs (identified here via ‘combn’):
site.info2$habitat <- as.factor(site.info2$habitat)
site.info2$type <- as.factor(site.info2$type)
site.info2$intx <- as.factor(site.info2$intx)

# Pairwise tests:
(pairs <- combn(levels(site.info2$intx), 2))

(pairs <- pairs[,c(1,2,4,7,9,11,14,10,15)]) # we only care about a subset of these possible pairs
# Pairwise tests: 
p.val <- rep(NA,9)  # Set up vector to hold pairwise p-values
for(i in 1:9) {
  pr <- pairs[,i]
  sub <- is.element(site.info2$intx, pr)
  d.pair <- vegdist(std.wide[sub,], method = "bray")
  cat("\n\nComparing", pr, ":\n")
  print(fit <-adonis2(d.pair ~ intx, data=site.info2[sub,], perm=1999, by = "margin"))
  p.val[i] <- fit[1,5]  # Save p-values
  names(p.val)[i] <- paste(pr[1], "-", pr[2], sep="")
}

p.val # p.val for the three informative pairwise values
#### comparisons of same habitat and different gear types
# eelgrass seine versus edna - significantly diff
# kelp seine versus edna - significantly diff
# mixed seine versus edna - significantly diff

#### comparison of different habitat and same gear types
# edna eelgrass versus kelp - significantly diff
# edna eelgrass versus mixed - significantly diff (0.044)
# edna mixed versus kelp - significantly diff 
# seine eelgrass versus kelp - NOT significantly diff
# seine eelgrass versus mixed - NOT significantly diff
# seine mixed versus kelp - NOT significantly diff
```

#visualize
## nmds
```{r}
nmds <- metaMDS(bray.wide, k = 2, autotransform = FALSE, trymax = 999)
nmds$stres # higher stress 27%; not the best fit in two dimensions
stressplot(nmds) # not the most idea... 

# quick fun plot
# plot the data
par(mfrow=c(1,1))
ordiplot(nmds, display = "site", type = "p", cex=1,)
ordiellipse(nmds, site.info2$intx)
```

### 3 axes nmds
nmds w/ three axes
```{r}
nmds3 <- metaMDS(bray.wide, k = 3, autotransform = FALSE, trymax = 999)
nmds3$stres # stress acceptable at 20.1%
stressplot(nmds3) # better...
scores(nmds3)

par(mfrow=c(1,1))
ordiplot(nmds3, display = "site", type = "p", cex=1,)
ordiellipse(nmds3, site.info2$intx)
```

Extract scores
```{r}
# extract scores from the nmds
scrs3 <- as.data.frame(scores(nmds3, display = 'sites'))
scrs3 <- cbind(as.data.frame(scrs3), intx = site.info2$intx)
cent <- aggregate(cbind(NMDS1, NMDS2, NMDS3) ~ intx, data =scrs3, FUN = mean)
segs <- merge(scrs3, setNames(cent, c('intx', 'oNMDS1', 'oNMDS2', 'oNMDS3')),
              by = "intx", sort = FALSE)

# create species vectors correlated w/ nmds axis
vec.sp3 <- envfit(as.data.frame(nmds3$points),
                  std.wide[,1:20], perm = 999, 
                  choices = 1:3) # choices 1:3  REQUIRED to have it run with all three axes (nmds1, nmds2, nmds3)
vec.sp.arrows3 <- scores(vec.sp3, display = "vectors")
vec.sp.dat3 <- data.frame(vec.sp.arrows3)
vec.sp.dat3$pvals <- vec.sp3$vectors$pvals
vec.sp.dat3$sp_code <- row.names(vec.sp.dat3)
vec.sp.dat3$r2 <- vec.sp3$vectors$r

# filter by species that are sig correlated w/ nmds axis
vec.sp.dat.sig3 <- vec.sp.dat3 %>%
  filter(pvals < 0.01)

#vec.sp.dat.sig <- vec.sp.dat.sig %>%
#  dplyr::select(MDS1, MDS2, pvals, sp_code, r2, sp_code) 

# scale by nmds? This might've been done up above see 
# https://stackoverflow.com/questions/14711470/plotting-envfit-vectors-vegan-package-in-ggplot2

scrs3 <- scrs3 %>%
  separate(intx, into = c("habitat", "type"), remove = F) %>%
  rownames_to_column(var = "bay_year") %>%
  left_join(site.info2, by = c("bay_year", "intx", "habitat", "type"))

scrs.edna <- scrs3 %>%
  filter(type == "edna")

```

### 3 axes w/o species
remake without the species vectors
```{r}
w1 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS1, y = NMDS2, 
                               color = as.factor(habitat), shape = as.factor(type)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS1, y = NMDS2, linetype = as.factor(type)),
               linewidth = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS1, y = NMDS2, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS1, y = 0, yend = MDS2),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, 
  #                  aes(x = MDS1, y = MDS2, label = sp_code),
  #                  size = 4, inherit.aes = FALSE) +
  coord_fixed() +
  scale_shape_manual(name = "Gear Type", 
                     labels = c("eDNA", "Beach seine"),
                     values = c("circle", "triangle")) +
  scale_linetype_manual(name = "Gear Type",
                     labels = c("eDNA", "Beach seine"),
                     values = c("solid", "dashed")) +
  scale_color_manual(name = "Habitat",
                     labels = c("Eelgrass", "Understory kelp", "Mixed eelgrass"),
                     values = c("#73A580","#D16103", "#E1AD01")) +
  labs(x = "NMDS1", y = "NMDS2") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +  
  theme(legend.key.width = unit(2, "cm"))

w2 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS1, y = NMDS3, 
                               color = as.factor(habitat), shape = as.factor(type)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS1, y = NMDS3, linetype = as.factor(type)),
               size = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS1, y = NMDS3, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS1, y = 0, yend = MDS3),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, aes(x = MDS1, y = MDS3, label = sp_code), 
  #                  size = 4, inherit.aes = FALSE) +
  coord_fixed() +
  scale_shape_manual(name = "Gear Type", 
                     labels = c("eDNA", "Beach seine"),
                     values = c("circle", "triangle")) +
  scale_linetype_manual(name = "Gear Type",
                     labels = c("eDNA", "Beach seine"),
                     values = c("solid", "dashed")) +
  scale_color_manual(name = "Habitat",
                     labels = c("Eelgrass", "Understory kelp", "Mixed eelgrass"),
                     values = c("#73A580","#D16103", "#E1AD01")) +
  labs(x = "NMDS1", y = "NMDS3") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.key.width = unit(2, "cm")) 

w3 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS2, y = NMDS3, 
                               color = as.factor(habitat), shape = as.factor(type)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS2, y = NMDS3, linetype = as.factor(type)),
               size = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS2, y = NMDS3, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS2, y = 0, yend = MDS3),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, aes(x = MDS2, y = MDS3, label = sp_code), 
  #                  size = 4, inherit.aes = FALSE) +
  scale_shape_manual(name = "Gear Type", 
                     labels = c("eDNA", "Beach seine"),
                     values = c("circle", "triangle")) +
  scale_linetype_manual(name = "Gear Type",
                     labels = c("eDNA", "Beach seine"),
                     values = c("solid", "dashed")) +
  scale_color_manual(name = "Habitat",
                     labels = c("Eelgrass", "Understory kelp", "Mixed eelgrass"),
                     values = c("#73A580","#D16103", "#E1AD01")) +
  labs(x = "NMDS2", y = "NMDS3") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.key.width = unit(2, "cm"))


plot_novector <- w1 + w2 + w3 + guide_area() +
  plot_layout(guides = "collect", ncol = 2) +
  plot_annotation(tag_levels = "a")


 # ggsave(plot_novector, filename = "Images/wc_seine_eDNA_comparison_nmds.png",
 #        width = 12, height = 12)
```

### 3d nmds w/ colored ellipses
```{r}
w4 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS1, y = NMDS2, 
                               color = as.factor(intx), shape = as.factor(intx)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS1, y = NMDS2, linetype = as.factor(intx),
                                 color = as.factor(intx)),
               linewidth = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS1, y = NMDS2, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS1, y = 0, yend = MDS2),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, 
  #                  aes(x = MDS1, y = MDS2, label = sp_code),
  #                  size = 4, inherit.aes = FALSE) +
  coord_fixed() +
  scale_shape_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("circle", "triangle",
                                "circle", "triangle", 
                                "circle", "triangle")) +
  scale_linetype_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("solid", "dashed",
                                "solid", "dashed",
                                "solid", "dashed")) +
  scale_color_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("#73A580", "#73A580",
                                "#D16103", "#D16103",
                                "#E1AD01", "#E1AD01")) +
  labs(x = "NMDS1", y = "NMDS2") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +  
  theme(legend.key.width = unit(2, "cm"))

w5 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS1, y = NMDS3, 
                               color = as.factor(intx), shape = as.factor(intx)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS1, y = NMDS3, linetype = as.factor(intx),
                                 color = as.factor(intx)),
               size = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS1, y = NMDS3, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS1, y = 0, yend = MDS3),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, aes(x = MDS1, y = MDS3, label = sp_code), 
  #                  size = 4, inherit.aes = FALSE) +
  coord_fixed() +
 scale_shape_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("circle", "triangle",
                                "circle", "triangle", 
                                "circle", "triangle")) +
  scale_linetype_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("solid", "dashed",
                                "solid", "dashed",
                                "solid", "dashed")) +
  scale_color_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("#73A580", "#73A580",
                                "#D16103", "#D16103",
                                "#E1AD01", "#E1AD01")) +
  labs(x = "NMDS1", y = "NMDS3") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.key.width = unit(2, "cm")) 

w6 <- ggplot() +
    geom_point(data = scrs3, aes(x = NMDS2, y = NMDS3, 
                               color = as.factor(intx), shape = as.factor(intx)),
             size = 2) +
  stat_ellipse(data = scrs3, aes(x = NMDS2, y = NMDS3, linetype = as.factor(intx),
                                 color = as.factor(intx)),
               size = 2) +
  geom_polygon(data = scrs.edna, aes(x = NMDS2, y = NMDS3, group = bay_year2), 
               fill = "lightgray", color = "gray", alpha = 0.4) +
  # geom_segment(data = vec.sp.dat.sig3, aes(x = 0, xend = MDS2, y = 0, yend = MDS3),
  #              inherit.aes=FALSE) +  # add arrows
  # geom_label_repel(data = vec.sp.dat.sig3, aes(x = MDS2, y = MDS3, label = sp_code), 
  #                  size = 4, inherit.aes = FALSE) +
 scale_shape_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("circle", "triangle",
                                "circle", "triangle", 
                                "circle", "triangle")) +
  scale_linetype_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("solid", "dashed",
                                "solid", "dashed",
                                "solid", "dashed")) +
  scale_color_manual(name = "Habitat & Gear Type", 
                     labels = c("Eelgrass, sampled with eDNA",
                                "Eelgrass, sampled with seine", 
                                "Understory kelp, sampled with eDNA",
                                "Understory kelp, sampled with seine",
                                "Mixed eelgrass, sampled with eDNA", 
                                "Mixed eelgrass, sampled with seine"),
                     values = c("#73A580", "#73A580",
                                "#D16103", "#D16103",
                                "#E1AD01", "#E1AD01")) +
  labs(x = "NMDS2", y = "NMDS3") +
  plot_theme() +
  guides(shape = guide_legend(override.aes = list(size = 3)),
         color = guide_legend(override.aes = list(size = 3))) +
  theme(legend.key.width = unit(2, "cm"))


plot_singlelegend <- w4 + w5 + w6 + guide_area() +
  plot_layout(guides = "collect", ncol = 2) +
  plot_annotation(tag_levels = "a")


# ggsave(plot_singlelegend, filename = "Images/wc_seine_eDNA_comparison_nmds_intxellipses.png",
#        width = 12, height = 12)
```

## pcoa
```{r}
pcoa.bray <- cmdscale(bray.wide, eig = T)
colnames(pcoa.bray$points) <- c("pcoa1", "pcoa2")
plot(pcoa.bray$points)

percent_explained <- 100* pcoa.bray$eig/ sum(pcoa.bray$eig)
pe <- format(round(percent_explained[1:2], digits = 1), nsmall = 1, trim = T)

pcoalabs <- as.list(c(glue::glue("PCoA 1 ({pe[1]}%)"),
          glue::glue("PcoA 2 ({pe[2]}%)")))

# create species vectors w/ envfit
pcoa.sp <- envfit(as.data.frame(pcoa.bray$points),
                  std.wide[,1:70], perm = 999)
pcoa.sp.dat <- data.frame(scores(pcoa.sp, display = "vectors"))
pcoa.sp.dat$pvals <- pcoa.sp$vectors$pvals
pcoa.sp.dat$sp_code <- row.names(pcoa.sp.dat)
pcoa.sp.dat$r2 <- pcoa.sp$vectors$r2
pcoa.sp.dat.sig <- filter(pcoa.sp.dat, pvals < 0.01)


pcoa <- pcoa.bray$points %>%
  as_tibble(rownames = "bay_year") %>%
  left_join(site.info2) %>%
  ggplot(aes(x = pcoa1, y = pcoa2, color = habitat, shape = type)) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", linewidth = 0.5) +
  geom_vline(aes(xintercept = 0), linetype = "dashed", linewidth = 0.5) +
  # geom_polygon(aes(x = pcoa1, y = pcoa2, group = bay_year2),
  #              fill = "lightgray", alpha = 0.6,
  #              data = {pcoa.bray$points %>% as_tibble(rownames = "bay_year") %>%
  # left_join(site.info) %>% filter(., type == "edna")}) +
  geom_point(size = 3) + 
  stat_ellipse(aes(x = pcoa1, y = pcoa2, linetype = type, color = habitat),
               linewidth = 2) +
  geom_segment(data = pcoa.sp.dat.sig, aes(x = 0, xend = pcoa1, y = 0, yend = pcoa2),
               inherit.aes=FALSE, linewidth = 1) +  # add arrows
  geom_label_repel(data = pcoa.sp.dat.sig,
                   aes(x = pcoa1, y = pcoa2, label = sp_code),
                   size = 4, inherit.aes = FALSE) +
                   #nudge_x = ifelse(vec.sp.dat.sig3$MDS1 >= 0, 0.2, -0.2), 
                   #nudge_y = ifelse(vec.sp.dat.sig3$MDS2 >= 0, 0.2, -0.2),
                    #max.overlaps = getOption("ggrepel.max.overlaps", default = 17)) +
  scale_color_manual(name = "Habitat", 
                     labels = c("Eelgrass", "Understory kelp", "Mixed eelgrass"),
                     values = c("#73A580","#D16103", "#E1AD01")) +
  scale_linetype_manual(name = "Gear Type", 
                        labels = c("eDNA", "Beach seine"), 
                        values = c("solid", "dashed")) +
  scale_shape_manual(name = "Gear Type", 
                     labels = c("eDNA", "Beach seine"),
                     values = c("circle", "triangle")) +
  #theme(legend.position = "none") +
  labs(x = pcoalabs[[1]], y = pcoalabs[[2]]) +
    plot_theme() +
    theme(legend.key.width = unit(2, "cm"))

pcoa
# ggsave(filename = "Images/wc_pcoa_edna-seine_bray.png", plot = pcoa,
#       height = 8, width = 14)
```

# SIMPER Analysis
```{r}
sim <- simper(std.wide, site.info2$intx, permutations = 999)
sum <- summary(sim)
# habitat differences
s1 <- sum$eelgrass_edna_kelp_edna %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "eelgrass_edna_kelp_edna",
         title = "Habitat comparison sampled with eDNA")
s2 <- sum$eelgrass_edna_mixed_edna %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "eelgrass_edna_mixed_edna",
         title = "Habitat comparison sampled with eDNA")
s3 <- sum$kelp_edna_mixed_edna %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "kelp_edna_mixed_edna",
         title = "Habitat comparison sampled with eDNA")
s4 <- sum$eelgrass_seine_kelp_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "eelgrass_seine_kelp_seine",
         title = "Habitat comparison sampled with beach seine")
s5 <- sum$eelgrass_seine_mixed_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "eelgrass_seine_mixed_seine",
         title = "Habitat comparison sampled with beach seine")
s6 <- sum$kelp_seine_mixed_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "kelp_seine_mixed_seine", 
         title = "Habitat comparison sampled with beach seine")

# gear type differences
s7 <- sum$eelgrass_edna_eelgrass_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "eelgrass_edna_eelgrass_seine",
         title = "Gear type comparison in eelgrass")
s8 <- sum$mixed_edna_mixed_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "mixed_edna_mixed_seine",
         title = "Gear type comparison in mixed eelgrass")
s9 <- sum$kelp_edna_kelp_seine %>%
  filter(p < 0.05) %>%
  rownames_to_column("sp_code") %>%
  mutate(comparison = "kelp_edna_kelp_seine",
         title = "Gear type comparison in understory kelp")


simper.sp <- rbind(s1, s2) %>%
  rbind(s3) %>%
  rbind(s4) %>%
  rbind(s5) %>%
  rbind(s6) %>%
  rbind(s7) %>%
  rbind(s8) %>%
  rbind(s9) %>%
  mutate(average = round(average * 100, 2))

simper.sp$label <- sprintf("%.1f%%", simper.sp$average)

habitat.simper <- filter(simper.sp, 
                         title %in% c("Habitat comparison sampled with beach seine",
                                          "Habitat comparison sampled with eDNA"))

gear.simper <- 
  filter(simper.sp, !(title %in% c("Habitat comparison sampled with beach seine",
                                          "Habitat comparison sampled with eDNA")))
```

Make average proportional graphs for the species that constitute a significant difference between the intx (from permanova)
###simper habitat 
```{r}
habitat.plots <- list()
abund.df <- list()
#i <- "eelgrass_edna_kelp_edna"
# Habitat loop
for(i in unique(habitat.simper$comparison)){
  dat <- filter(habitat.simper, comparison == i) %>%
    separate(comparison, into = c("hab1", "type1", "hab2", "type2"), remove = F) %>%
    mutate(name = sp_code)
  
  abund <- long %>%
    left_join(site.info2) %>%
    filter(habitat %in% c(dat$hab1, dat$hab2),
           type %in% c(dat$type1, dat$type2),
           name %in% c(dat$sp_code)) %>%
    mutate(habitat = ifelse(habitat == "eelgrass", "Eelgrass",
                            ifelse(habitat == "mixed", "Mixed eelgrass",
                                   ifelse(habitat == "kelp", "Understory kelp", habitat)))) %>%
    group_by(name, intx, habitat, type) %>%
    dplyr::summarize(avg = mean(value),
                     sd = sd(value))
   full.dat <- left_join(abund, dat, by = "name")
   abund.df[[i]] <- full.dat
  
   plot <- ggplot(full.dat) +
    geom_col(aes(x = habitat, y = avg), color = "black") +
    geom_errorbar(aes(x = habitat, ymin = avg, ymax = avg + sd.x),
                  width = 0.15) +
    geom_text(mapping = aes(x = Inf, y = Inf, label = label), 
            inherit.aes = FALSE, hjust = 1.1, vjust = 1.4, size = 5) +
    labs(x = "Habitat", y = "Average proportion") +
         #title = unique(dat$title)) +
    plot_theme_small() +
    facet_wrap(~reorder(name, -average))
   
   habitat.plots[[i]] <- plot

}


habitat.plots

```

### simper gear type
```{r}
gear.plots <- list()
abund.type.df <- list()

# Gear type loop
for(i in unique(gear.simper$comparison)){
  dat <- filter(gear.simper, comparison == i) %>%
    separate(comparison, into = c("hab1", "type1", "hab2", "type2"), remove = F) %>%
    mutate(name = sp_code)
  
  abund <- long %>%
    left_join(site.info2) %>%
    filter(habitat %in% c(dat$hab1, dat$hab2),
           type %in% c(dat$type1, dat$type2),
           name %in% c(dat$sp_code)) %>%
    mutate(habitat = ifelse(habitat == "eelgrass", "Eelgrass",
                            ifelse(habitat == "mixed", "Mixed eelgrass",
                                   ifelse(habitat == "kelp", "Understory kelp", habitat))),
           type = ifelse(type == "seine", "Beach seine",
                         ifelse(type == "edna", "eDNA", type))) %>%
    group_by(name, intx, habitat, type) %>%
    dplyr::summarize(avg = mean(value),
                     sd = sd(value))
  
   full.dat <- left_join(abund, dat, by = "name")
   abund.type.df[[i]] <- full.dat
   
    plot <- ggplot(full.dat) +
    geom_col(aes(x = type, y = avg), color = "black") +
    geom_errorbar(aes(x = type, ymin = avg, ymax = avg + sd.x),
                  width = 0.15) +
    geom_text(mapping = aes(x = Inf, y = Inf, label = label), 
            inherit.aes = FALSE, hjust = 1.1, vjust = 1.4, size = 5) +
    labs(x = "Gear type", y = "Average proportion") +
         #title = unique(dat$title)) +
    plot_theme_small() +
    facet_wrap(~reorder(name, -average))
   
   gear.plots[[i]] <- plot

}

gear.plots

```


# Indicator analysis
## abundance based
This is following a tutorial from a UW course https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/isa/ and talks about classical versus modified indicator analysis with the main difference being if the indicator species are for a single group (e.g. for habitat just eelgrass) or for a combination of groups (e.g. for habitat species A being an indicator for eelgrass and mixed eelgrass). 
See blog for more information. 
Uses library indicspecies::multipatt - which studies the **association** between species patterns and combinations of groups of sites

Another source of information about indicator species is here chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://sites.ualberta.ca/~ahamann/teaching/renr690/seminars/Indicator.pdf and here:
https://apsjournals.apsnet.org/doi/10.1094/PHYTO-12-19-0462-LE?url_ver=Z39.88-2003&rfr_id=ori:rid:crossref.org&rfr_dat=cr_pub%20%200pubmed

Input is a species matrix, unsure if it should be standardized first or not (documentation doesn't have standardization, but the example I'm following does)
Should probably try both and compare result. 
```{r}
library(indicspecies)
head(wide) # non standardized
head(std.wide) # standardized (wisconsin double standardization)
head(site.info2)
# okay from the abundance based permanvoa we know there's a significant interaction between habitat and gear type, so we want to include that complexity

# Non standardized
# note for restricting certain groups we have to understand that multipatt considers the groups as integers, so groups by themselves are first 1:n, and then combinations are listed after n. So for interaction; the first four groups are 1:4, 5+ arecombinations based on group1+2 = 5; group1+3 = 6 etc. 
set.seed(09281992)
all.comb <- multipatt(wide, cluster = site.info2$intx, func = "IndVal.g")
colnames(as.data.frame(all.comb$comb)) # use this to determine which sensicle combinations should be included. 

indic <- multipatt(wide, cluster = site.info2$intx, func = "IndVal.g",
                   restcomb = c(1:8, 10, 13, 15, 16, 17, 20, 21, 27, 36)) # only including sensical combinations
summary(indic, alpha = 0.05, indvalcomp = TRUE)

comb <- as.data.frame(indic$comb)
combinations <- as.data.frame(colnames(comb)) %>%
  rownames_to_column(var = "index") %>%
  mutate(index = as.integer(index)) %>%
  dplyr::rename(comb = "colnames(comb)")# this has indexed the combinations that got included and are represented as indexes in inidic.sign below. 

# if we look at the indic object before summary then it kind shows us the combinations: 
#' eelgrass_edna 1, eelgrass_seine 2, kelp_edna 3, kelp_seine 4, mixed_enda 5, mixed_seine 6, 
#' eelgrass_edna + eelgrass_seine 7, eelgrass_enda + kelp_edna 8, eel_edna +kelp seine 9, eel edna + mixed edna 10
#' eel edna + mixed seine 11, eel seine + kelp edna 12, eel seine + kelp seine 13, eelgras seine + mixed edna 14
#' eel seine + mixed seine 15, kelp edna + kelp seine 16, kelpenda +  mixed edna 17, kelp edna+mixed seine 18, 
#' kelp_seine + mixed edna 19, kelp_seine + mixed seine 20, mixed edna + mixed seine 21, 
#' eelgrass_edan + eelgrass seine +kelp seine 22, eel edan + eel seine + mixed edna 23, eel_edna + eel seine + mixed seine 24
#' eel edna + kelp edna + kelp sine 25, eel edna + kelp edna + kelp seine 26, eel edna + kelp edna + mixed edna 27, 
#' eel edna + kelp edna + mixed seine 28, eel edna + kelp seine + mixed seine 29, eel edna + mixed edna + mixed seine 30,
#' eel seine + kelp edna + kelp seine 31, eel seine + kelp edna + mixed edna 32, eel seine + kelp edna + mixed seine 33, 
#' eel seine + kelp seine + mixed edna 34, eel seine + kelp seine + mixed seine 35, eel seine + mixed edna + mixed seine 36,
#' kelp edna + kelp seine + mixed edna 37, kelp edna + kelp seine + mixed seine 38, kelp edna + mixed edna + mixed seine 39,
#' kelp seine + mixed edna + mixed seine 40
#' 

# one caveat about this (see help documentation) is t hat because we're using combinations (not the classical ISA) I **think** we need to account for type I error 
library(data.table)
indic.sign <- as.data.table(indic$sign, keep.rownames = TRUE)
#add adjusted p-value
indic.sign[ ,p.value.bh:=p.adjust(p.value, method="BH")]

indic.sign.bh <- indic.sign[p.value.bh <=0.05] %>%
  dplyr::select(c(rn, stat, index, p.value, p.value.bh)) %>%
  arrange(index) %>%
  left_join(combinations, by = "index") %>%
  separate(comb,sep = "\\+", into = c("intx1", "intx2", "intx3"), remove = F)

unique(indic.sign.bh$comb)

```

### indic sp plots
```{r}
sp.palette <- hcl.colors(18)

# create a loop that goes through each combination and pulls abundance data so its in a single dataframe, we can then facet wrap by combination
indic.dat <- data.frame()

for(i in unique(indic.sign.bh$index)){
  sp.by.index <- filter(indic.sign.bh, index == i)
  tmp <- filter(long, name %in% sp.by.index$rn,
         intx %in% unique(c(sp.by.index$intx1, 
                            sp.by.index$intx2, sp.by.index$intx3))) %>%
    mutate(comb = unique(sp.by.index$comb),
           index = i)
  
  indic.dat <- rbind(indic.dat, tmp)

}


p1 <- indic.dat %>%
  filter(comb %in% c("eelgrass_edna+kelp_edna+mixed_edna", 
                             "eelgrass_seine+kelp_seine+mixed_seine")) %>%
  mutate(comb = ifelse(comb == "eelgrass_edna+kelp_edna+mixed_edna",
                       "All habitats eDNA", 
                       ifelse(comb == "eelgrass_seine+kelp_seine+mixed_seine",
                              "All habitats seine", comb))) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = name, y = value, fill = name)) +
  labs(x = NULL, y = "Proportional abundance",
       fill = "Scientific Name") +
  scale_fill_manual(values = sp.palette) +
  plot_theme() +
  theme(legend.position = "none",
        #axis.text.x = element_text(angle = 45, hjust = 1)
        ) +
  facet_row(~comb, scales = "free", space = "free") 

p1

p2 <- indic.dat %>%
  filter(comb %in% c("kelp_seine", "mixed_seine",
                     "kelp_seine+mixed_seine")) %>%
  mutate(comb = ifelse(comb == "kelp_seine",
                       "Seine: understory kelp", 
                       ifelse(comb == "mixed_seine",
                              "Seine: mixed eelgrass", 
                               ifelse(comb == "kelp_seine+mixed_seine",
                                     "Seine: kelp & mixed eelgrass", comb)))) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = name, y = value, fill = name)) +
  labs(x = NULL, y = "Proportional abundance",
       fill = "Scientific Name") +
  scale_fill_manual(values = sp.palette) +
  plot_theme() +
  theme(legend.position = "none",
        #axis.text.x = element_text(angle = 45, hjust = 1)
        ) +
  facet_row(~comb, scales = "free", space = "free") 

p2

p3 <- indic.dat %>%
  filter(comb %in% c("eelgrass_edna",
                     "eelgrass_edna+kelp_edna",
                     "eelgrass_edna+eelgrass_seine", 
                     "eelgrass_seine+mixed_seine")) %>%
  mutate(comb = ifelse(comb == "eelgrass_edna",
                       "eDNA: eelgrass", 
                       ifelse(comb == "eelgrass_edna+kelp_edna",
                              "eDNA: eelgrass & kelp", 
                              ifelse(comb == "eelgrass_edna+eelgrass_seine",
                                     "Eelgrass: eDNA & seine", 
                                     ifelse(comb == "eelgrass_seine+mixed_seine",
                                            "Seine: eelgrass & mixed eelgrass", comb))))) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = name, y = value, fill = name)) +
  labs(x = "Indicator species scientific name", y = "Proportional abundance",
       fill = "Scientific Name") +
  scale_fill_manual(values = sp.palette) +
  plot_theme() +
  theme(legend.position = "none",
        #axis.text.x = element_text(angle = 45, hjust = 1)
        ) +
  facet_row(~comb, scales = "free", space = "free") 

p3


indicator <- p1 / p2 / p3 +
  plot_layout(axes = "collect_y")

# ggsave(filename = "Images/wc_indicator_sp.png",
#        plot = indicator,
#        height = 12, width = 18)



# ggplot(indic.dat) +
#   geom_boxplot(mapping = aes(x = name, y = value, fill = name)) +
#   labs(x = NULL, y = "Proportional abundance",
#        fill = "Scientific Name") +
#   scale_fill_manual(values = sp.palette) +
#   plot_theme() +
#   theme(legend.position = "none",
#         #axis.text.x = element_text(angle = 45, hjust = 1)
#         ) +
#   facet_wrap(~comb, scales = "free") 
```

Next we want to create a figure that looks at seine data and plot what it looks like to have
species proportion on the x axis and species abundance on the y axis 
facet_wrap by hab


#compare seine prop to abund
```{r}
seine.corrected.abund <- seine %>% # first fix the unflat, unscul, unrock species with max sp at the site
  mutate(species_scientific = ifelse(sp_code == "UNFLAT", "Parophrys vetulus", species_scientific),
         species_scientific = ifelse(sp_code == "UNSCUL", "Artedius spp.", species_scientific),
         species_scientific = ifelse(sp_code == "UNROCK", "Sebastes caurinus", species_scientific)) %>%
  mutate(species_scientific = ifelse(species_common == "Copperquillback juvenile rockfish", 
                                     "Sebastes maliger", species_scientific),
         species_scientific = ifelse(species_common == "Yellowtail/black juvenile rockfish complex",
                                     "Sebastes flavidus", species_scientific),# this isn't 100p but we'll work when we leftjoin with taxongrp to correctly put it into the right sebastes group
         species_scientific = ifelse(species_scientific == "Lepidopsetta spp.", "Lepidopsetta polyxystra",
                                     species_scientific)) %>%
  left_join(taxongrp, by = c("species_scientific" = "species")) %>%
  # dplyr::select(-c(bay_year, bay_id, habitat, fork_length, mass_g, abundance, type)) %>%
  # distinct() %>%
  mutate(corrected_sp = ifelse(is.na(taxon), species_scientific, taxon)) %>%
  group_by(bay_year, habitat, corrected_sp, type) %>%
  dplyr::summarise(total_abund = sum(abundance)) %>%
  mutate(bay_year2 = bay_year) #%>%
  # group_by(bay_year, bay_year2, habitat, type) %>% # ugly code but have to change seine data to prop abund
  # mutate(total = sum(value)) %>%
  # ungroup() %>%
  # group_by(bay_year, bay_year2, habitat, type, total, corrected_sp) %>%
  # dplyr::summarize(value = sum(value)/total) %>%
  # ungroup() %>%
  # dplyr::select(-total) %>%
  # distinct()

seine.both <- left_join(seine.corrected, seine.corrected.abund)

nrow(seine.corrected); nrow(seine.corrected.abund); nrow(seine.both) # all same length, good

table(is.na(seine.both)) # no NAs
```

graph it
```{r}

ggplot(seine.both) +
  geom_point(aes(x = value, y = total_abund/100, color = corrected_sp), size = 4) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  plot_theme_bw() +
  theme(legend.position = "none") +
  facet_wrap(~habitat, scales = "free")


ggplot(seine.both) +
  geom_point(aes(x = value, y = total_abund/100)) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") +
  scale_x_continuous(expand = c(0,0), limits = c(0, .20)) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 5)) +
  plot_theme_bw() +
  theme(legend.position = "none") 


```

